from threading import Thread, Lock, active_count
import time
import socket

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_address = ('localhost', 10000)
sock.bind(server_address)
sock.listen(5)

mutex_print = Lock()

mutex_print.acquire()
try:
    print(active_count())
finally:
    mutex_print.release()

def thread_client_socket(conn):
    while True:
        try:
            while True:
                data = conn.recv(16)
                mutex_print.acquire()
                try:
                    print(str(data))
                finally:
                    mutex_print.release()
                if not data:
                    break
        finally:
            conn.close()
            break
    mutex_print.acquire()
    try:
        print('this thread is done')
    finally:
        mutex_print.release()
    

while True:
    connection, client_address = sock.accept()#stalling
    thread = Thread(target = thread_client_socket, args = (connection,))
    thread.start()
    mutex_print.acquire()
    try:
        print(active_count())
    finally:
        mutex_print.release()
